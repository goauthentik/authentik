version: 1
context:
    foo: bar
    policy_property: name
    policy_property_value: foo-bar-baz-qux
    sequence:
    - foo
    - bar
    mapping:
      key1: value
      key2: 2
entries:
    - model: !Format ["%s", authentik_sources_oauth.oauthsource]
      state: !Format ["%s", present]
      identifiers:
          slug: test
      attrs:
          name: test
          provider_type: github
          consumer_key: !Env foo
          consumer_secret: !Env [bar, baz]
          authentication_flow:
              !Find [
                  authentik_flows.Flow,
                  [slug, default-source-authentication],
              ]
          enrollment_flow:
              !Find [authentik_flows.Flow, [slug, default-source-enrollment]]
    - attrs:
          expression: return True
      identifiers:
          name: !Format [foo-%s-%s-%s, !Context foo, !Context bar, qux]
      id: policy
      model: authentik_policies_expression.expressionpolicy
    - attrs:
          attributes:
              policy_pk1:
                  !Format [
                      "%s-%s",
                      !Find [
                          authentik_policies_expression.expressionpolicy,
                          [
                              !Context policy_property,
                              !Context policy_property_value,
                          ],
                          [expression, return True],
                      ],
                      suffix,
                  ]
              policy_pk2: !Format ["%s-%s", !KeyOf policy, suffix]
              boolAnd:
                  !Condition [AND, !Context foo, !Format ["%s", "a_string"], 1]
              boolNand:
                  !Condition [NAND, !Context foo, !Format ["%s", "a_string"], 1]
              boolOr:
                  !Condition [
                      OR,
                      !Context foo,
                      !Format ["%s", "a_string"],
                      null,
                  ]
              boolNor:
                  !Condition [
                      NOR,
                      !Context foo,
                      !Format ["%s", "a_string"],
                      null,
                  ]
              boolXor:
                  !Condition [XOR, !Context foo, !Format ["%s", "a_string"], 1]
              boolXnor:
                  !Condition [XNOR, !Context foo, !Format ["%s", "a_string"], 1]
              boolComplex:
                  !Condition [
                      XNOR,
                      !Condition [AND, !Context non_existing],
                      !Condition [NOR, a string],
                      !Condition [XOR, null],
                  ]
              if_true_complex:
                  !If [
                      true,
                      {
                          dictionary:
                              {
                                  with: { keys: "and_values" },
                                  and_nested_custom_tags:
                                      !Format ["foo-%s", !Context foo],
                              },
                      },
                      null,
                  ]
              if_false_complex:
                  !If [
                      !Condition [AND, false],
                      null,
                      [list, with, items, !Format ["foo-%s", !Context foo]],
                  ]
              if_true_simple: !If [!Context foo, true, text]
              if_false_simple: !If [null, false, 2]
              for_mapping: !For [
                  !Context mapping,
                  MAP,
                  [!Format ["prefix-%s", !ForItemIndex 0], !Format ["other-prefix-%s", !ForItem 0]]
              ]
              for_sequence: !For [
                  !Context mapping,
                  SEQ,
                  !Format ["%s: %s", !ForItemIndex 0, !ForItem 0]
              ]
              for_sequence_complex: !For [
                  !Context sequence,
                  SEQ,
                  [
                      !For [
                          !ForItem 1,
                          SEQ,
                          {
                              key1: [
                                  !Format ["str: %s, str_index: %d, letter: %s", !ForItem 1, !ForItemIndex 1, !ForItem 0],
                                  !ForItem 1,
                                  !ForItem 0,
                                  !For [
                                      !ForItem 2,
                                      SEQ,
                                      {
                                        inner_inner_for_item: !Format ["%d-%s", !ForItemIndex 0, !ForItem 0]
                                      }
                                  ]
                              ],
                              key2: !ForItem 0
                          }
                      ],
                      !For [
                          !ForItem 1,
                          SEQ,
                          {
                              key1: {
                                  inner_key1: !Format ["letter: %s, str: %s, str_index: %d", !ForItem 0, !ForItem 1, !ForItemIndex 1],
                                  inner_key2: !ForItem 0,
                                  inner_key3: !ForItem 1
                              },
                              key2: !ForItem 0
                          }
                      ],
                      !ForItem 0,
                      !Format ["%s-%s", !Context foo, !ForItem 0]
                  ]
              ]
      identifiers:
          name: test
      conditions:
          - !Condition [AND, true, true, text]
          - true
          - text
      model: authentik_core.group
