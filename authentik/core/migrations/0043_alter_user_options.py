# Generated by Django 5.0.10 on 2025-01-08 17:39

from django.db import migrations
from django.apps.registry import Apps
from django.db.backends.base.schema import BaseDatabaseSchemaEditor


def migrate_user_debug_attribute(apps: Apps, schema_editor: BaseDatabaseSchemaEditor):
    from django.apps import apps as real_apps
    from django.contrib.auth.management import create_permissions

    db_alias = schema_editor.connection.alias

    User = apps.get_model("authentik_core", "User")
    USER_ATTRIBUTE_DEBUG = "goauthentik.io/user/debug"

    # Permissions are only created _after_ migrations are run
    # - https://github.com/django/django/blob/43cdfa8b20e567a801b7d0a09ec67ddd062d5ea4/django/contrib/auth/apps.py#L19
    # - https://stackoverflow.com/a/72029063/1870445
    create_permissions(real_apps.get_app_config("authentik_core"), using=db_alias)

    Permission = apps.get_model("auth", "Permission")

    new_prem = Permission.objects.using(db_alias).get(codename="user_view_debug")

    db_alias = schema_editor.connection.alias
    for user in User.objects.using(db_alias).filter(
        **{f"attributes__{USER_ATTRIBUTE_DEBUG}": True}
    ):
        user.permissions.add(new_prem)


class Migration(migrations.Migration):

    dependencies = [
        ("authentik_core", "0042_authenticatedsession_authentik_c_expires_08251d_idx_and_more"),
    ]

    operations = [
        migrations.AlterModelOptions(
            name="user",
            options={
                "permissions": [
                    ("reset_user_password", "Reset Password"),
                    ("impersonate", "Can impersonate other users"),
                    ("assign_user_permissions", "Can assign permissions to users"),
                    ("unassign_user_permissions", "Can unassign permissions from users"),
                    ("preview_user", "Can preview user data sent to providers"),
                    ("view_user_applications", "View applications the user has access to"),
                    ("user_view_debug", "User receives additional details for error messages"),
                ],
                "verbose_name": "User",
                "verbose_name_plural": "Users",
            },
        ),
        migrations.RunPython(migrate_user_debug_attribute),
    ]
