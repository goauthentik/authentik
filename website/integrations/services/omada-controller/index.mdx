---
title: Integrate with Omada Controller
sidebar_label: Omada Controller
support_level: community
---

## What is Omada Controller

> The Omada Controller is a software platform used to centrally manage and monitor Omada networking devices like access points, switches, and routers. It provides a single interface for configuring, managing, and monitoring these devices, offering centralized control over your entire Omada network.
>
> -- https://www.omadanetworks.com/

## Preparation

The following placeholders are used in this guide:

- `authentik.company` is the FQDN of the authentik installation.

:::note
This documentation lists only the settings that you need to change from their default values. Be aware that any changes other than those explicitly mentioned in this guide could cause issues accessing your application.
:::

## authentik configuration

To support the integration of Omada Controller with authentik, you need to create property mappings, a group, and an application/provider pair in authentik.

### Create property mappings in authentik

1. Log in to authentik as an administrator, and open the authentik Admin interface.
2. Navigate to **Customization** > **Property Mappings** and click **Create**. Create a **SAML Provider Property Mapping** with the following settings:

    - **Name**: `givenname`
    - **SAML Attribute Name**: `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname`
    - **Friendly Name**: Leave blank
    - **Expression**:

    ```python
    return request.user.name.split(" ", 1)[0]
    ```

3. Click **Finish**, followed by **Create**. Create another **SAML Provider Property Mapping** with the following settings:

    - **Name**: `surname`
    - **SAML Attribute Name**: `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname`
    - **Friendly Name**: Leave blank
    - **Expression**:

    ```python
    return request.user.name.split(" ", 1)[-1]
    ```

4. Click **Finish**, followed by **Create**. Create another **SAML Provider Property Mapping** with the following settings:

    - **Name**: `usergroup_name`
    - **SAML Attribute Name**: `usergroup_name`
    - **Friendly Name**: Leave blank
    - **Expression**:

    ```python
    for group in user.ak_groups.all():
        yield group.name
    ```

5. Click **Finish**, followed by **Create**. Create another **SAML Provider Property Mapping** with the following settings:

    - **Name**: `username`
    - **SAML Attribute Name**: `username`
    - **Friendly Name**: Leave blank
    - **Expression**:

    ```python
    return request.user.username
    ```

6. Click **Finish**

### Create a group in authentik

1. Log in to authentik as an administrator and open the authentik Admin interface.
2. Navigate to **Directory** > **Groups** and click **Create**.
3. Set a name for the group (e.g. `omada-admins`) and click **Create**.
4. Click the name of the newly created group and navigate to the **Users** tab.
5. Click **Add existing user**, select the user that needs Planka administrator access and click **Add**.

### Create an application and provider in authentik

1. Log in to authentik as an administrator, and open the authentik Admin interface.
2. Navigate to **Applications** > **Applications** and click **Create with Provider** to create an application and provider pair. (Alternatively you can first create a provider separately, then create the application and connect it with the provider.)

    - **Application**: provide a descriptive name, an optional group for the type of application, the policy engine mode, and optional UI settings.
        - Note the application slug, it will be required when filling out the **Identity provider SSO URL** later on. TEMP
    - **Choose a Provider type**: select **SAML Provider** as the provider type.
    - **Configure the Provider**: provide a name (or accept the auto-provided name), the authorization flow to use for this provider, and the following required configurations.
        - For Cloud Controller, set the **ACS URL** to `https://aps1-omada-account.tplinkcloud.com/sso/saml/login/`. For Software and Hardware Controllers, set the **ACS URL** as the IP Address and port of your controller followed by `/sso/saml/login` (e.g `https://<controller_ip>:8043/sso/saml/login`).
        - For Cloud Controller, set the **Entity ID** to `https://omada.tplinkcloud.com/`. For Software and Hardware Controllers, set the **Entity ID** as the IP Address and port of your Controller (e.g `https://<controller_ip>:8043`).
        - Set the **Service Provider Binding** to `Post`.
        - Under **Advanced protocol settings**:
            - Set an available signing certificate.
            - Set **NameID Property Mapping** to 'authentik default SAML Mapping: UPN'
            - Under **Property mappings**:
                - Select only the following **User Property Mappings**:
                    - `authentik default SAML Mapping: Email`
                    - `authentik default SAML Mapping: Name`
                    - `authentik default SAML Mapping: UPN`
                    - `givenname`
                    - `surname`
                    - `usergroup_name`
                    - `username`
    - **Configure Bindings** _(optional)_: you can create a [binding](/docs/add-secure-apps/flows-stages/bindings/) (policy, group, or user) to manage the listing and access to applications on a user's **My applications** page.

3. Click **Submit** to save the new application and provider.

### Copy the metadata URL

1. Log into authentik as an administrator, and open the authentik Admin interface.
2. Navigate to **Applications** > **Providers** and click on the name of the newly created Omada Controller provider.
3. Under **Metadata** click the **Copy Download URL** button. This metadata URL will be required in the next section.

## Omada Controller configuration

1. Log in to the Omada Controller.
2. Navigate to **Global View** > **Settings** > **SAML SSO**, then click **Add New SAML Connection**.
3. Set **Identity Provider Name** to `authentik`.
4. For **Configuration Method** select `Metadata URL`, and paste the metadata URL you copied from authentik.
5. Click **Load Info** followed by **Send**.
6. In the **Actions** column, click on the **Details** button of the newly created authentik SAML connection.
7. Take note of the **Entity ID**, **Omada ID**, **Resource ID**, and click **OK**. These values will be required in the next section.
8. At the top right of the page, click **Go To SAML Role**, followed by **Add New SAML Role**.
9. Set the desired **SAML Role Name**, **Role**, **User Type**, and **Privileges** for the new SAML role. The **SAML Role Name** must match the name of the previously created authentik group.
10. Click **Create**

## Encoding default relay state

The default relay state is derived by encoding a combination of the **Resource ID** and **Omada ID** with a Base64 encryption tool.

This can be done via the following command on Linux:

    ```bash
    echo -n '<Resource_ID>_<Omada_ID>' | base64
    ```

Or via the following powershell command on Windows:

    ```powershell
    [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes('<Resource_ID>_<Omada_ID>'))
    ```

:::note
The underscore between both values is required.
:::

## Reconfigure authentik provider

1. Log in to authentik as an administrator, and open the authentik Admin interface.
2. Navigate to **Applications** > **Providers** and click the **Edit** icon of the newly created Omada Controller provider.
3. Set **Issuer** to the **Entity ID** value from Omada Controller.
4. Under **Advanced protocol settings**, set **Default relay state** to the encoded value from the previous section.
5. Click **Update**

## Configuration verification

To verify that authentik is correctly integrated with Omada Controller, first log out of Omada Controller. Log in to authentik and click on the Omada Controller application in the application dashboard. You should then be redirected to the Omada Controller dashboard.

## Resources

- [Omada Networks Documentation - How to Configure SAML SSO on Omada Controller](https://www.omadanetworks.com/de/support/faq/4406/#_Toc193896083)
