== TMP DOCS FOR PG UPGRADE ==

1. Dump your database using `docker exec -it authentik-postgresql pg_dumpall -U authentik > upgrade_backup_12.sql`
2. Stop your containers by running docker compose stop
3. Take a backup of your existing database just to be safe
    - If you are using Docker volumes:
    docker volume create database-backup
    docker run --rm -v database:/from -v database-backup:/to alpine ash -c "cd /from && cp -a . /to"

    - If you are using directories on your host:
    cp /path/v12/db /path/v12/db-backup

4. Add a new Postgresql service to your docker-compose. Take the one you are using for version 12 and rename it. For example: authentik-postgresql -> authentik-postgresql-v16. Don't forget to change your volume name/location. Also update depends on.
5. Pull the new image with  docker compose pull
6. run with dc up --build -d

7. for this next step, you will need to remove all tables so 
SELECT 'DROP TABLE IF EXISTS "' || tablename || '" CASCADE;' 
FROM pg_tables 
WHERE schemaname = 'public';
and paste the sql

8. run cat upgrade_backup_12.sql | docker exec -i authentik-postgresql-v16 psql -U authentik to import your previous db

9. you must modify password type 
    - docker exec -it authentik-postgresql-v16 /bin/bash
    - vi /var/lib/postgresql/data/postgresql.conf
    - "i" to enter insert mode and uncomment `password_encryption = scram-sha-256` under Authentication
    - "escape", ":wq" to save and quit
    - psql into your db "psql -U authentik"

    you can run this sql if you wish for users which need upgrade:
    SELECT
    rolname, rolpassword ~ '^SCRAM-SHA-256\$' AS has_upgraded
    FROM pg_authid
    WHERE rolcanlogin;

    - "\password authentik" and enter the password you set your .env under PG_PASS

todo: fix err  psycopg.errors.DuplicateTable: relation "X" already exists 
todo: docker compose cleanup
todo: move this to markdown when ready